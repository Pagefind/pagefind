name: Web Components Tests > Filter dropdown renders with proper ARIA and filters results
steps:
  - step: I have the environment variable "PAGEFIND_SITE" set to "public"
  - step: I have a "public/index.html" file with the content {html}
    html: |-
      <!DOCTYPE html><html lang="en"><head>
      <link href="/pagefind/pagefind-component-ui.css" rel="stylesheet">
      </head><body>
      <div style="display: flex; gap: 24px;">
        <div style="display: flex; gap: 8px; align-items: flex-start;">
          <pagefind-filter-dropdown filter="type" label="Type"></pagefind-filter-dropdown>
          <pagefind-filter-dropdown filter="author" label="Author" single-select></pagefind-filter-dropdown>
        </div>
        <div style="flex: 1;">
          <pagefind-config preload></pagefind-config>
          <pagefind-input></pagefind-input>
          <pagefind-summary></pagefind-summary>
          <pagefind-results></pagefind-results>
        </div>
      </div>
      <script src="/pagefind/pagefind-component-ui.js" type="module"></script>
      </body></html>
  - step: I have a "public/guide-one/index.html" file with the content {html}
    html: |-
      <!DOCTYPE html><html lang="en"><head></head><body>
      <h1 data-pagefind-filter="type:Guide">First Guide</h1>
      <span data-pagefind-filter="author:Alice"></span>
      <p>This is the first guide about configuration.</p>
      </body></html>
  - step: I have a "public/guide-two/index.html" file with the content {html}
    html: |-
      <!DOCTYPE html><html lang="en"><head></head><body>
      <h1 data-pagefind-filter="type:Guide">Second Guide</h1>
      <span data-pagefind-filter="author:Bob"></span>
      <p>This is the second guide about setup.</p>
      </body></html>
  - step: I have a "public/tutorial/index.html" file with the content {html}
    html: |-
      <!DOCTYPE html><html lang="en"><head></head><body>
      <h1 data-pagefind-filter="type:Tutorial">Getting Started Tutorial</h1>
      <span data-pagefind-filter="author:Alice"></span>
      <p>This is a tutorial about configuration.</p>
      </body></html>
  - step: I have a "public/reference/index.html" file with the content {html}
    html: |-
      <!DOCTYPE html><html lang="en"><head></head><body>
      <h1 data-pagefind-filter="type:Reference">API Reference</h1>
      <span data-pagefind-filter="author:Charlie"></span>
      <p>This is the API reference documentation.</p>
      </body></html>
  - macro: I run Pagefind
  - step: stdout should contain "Running Pagefind"
  - step: The file "public/pagefind/pagefind.js" should not be empty
  - step: I serve the directory "public"
  - step: In my browser, I load "/"
  - step: In my browser, I evaluate {js}
    js: |-
      let trigger = await toolproof.querySelector(".pf-dropdown-trigger");
      toolproof.assert(trigger.getAttribute("role") === "combobox", "Trigger should have role=combobox");
      toolproof.assert(trigger.getAttribute("aria-haspopup") === "listbox", "Trigger should have aria-haspopup=listbox");
      toolproof.assert(trigger.getAttribute("aria-expanded") === "false", "Trigger should have aria-expanded=false initially");
      toolproof.assert(trigger.getAttribute("aria-controls") !== null, "Trigger should have aria-controls");
  - step: In my browser, I click the selector "pagefind-input input"
  - step: In my browser, I type "this"
  - step: In my browser, the console should be empty
  - step: In my browser, I evaluate {js}
    js: |-
      let results = await toolproof.querySelector("pagefind-results ul");
      await toolproof.waitFor(() => results.querySelectorAll("li").length === 4);
  - step: In my browser, I evaluate {js}
    js: |-
      let dropdown = await toolproof.querySelector("pagefind-filter-dropdown");
      await toolproof.waitFor(() => {
        let menu = dropdown.querySelector(".pf-dropdown-menu");
        return menu && menu.querySelectorAll('[role="option"]').length > 0;
      });
  - step: In my browser, I evaluate {js}
    js: |-
      let optionsContainer = await toolproof.querySelector(".pf-dropdown-options");
      toolproof.assert(optionsContainer.getAttribute("role") === "listbox", "Options container should have role=listbox");
      toolproof.assert(optionsContainer.getAttribute("aria-multiselectable") === "true", "First dropdown should be multiselectable");
  - step: In my browser, I evaluate {js}
    js: |-
      let dropdowns = await toolproof.querySelectorAll("pagefind-filter-dropdown");
      let singleSelectDropdown = dropdowns[1];
      let optionsContainer = singleSelectDropdown.querySelector(".pf-dropdown-options");
      toolproof.assert(optionsContainer.getAttribute("aria-multiselectable") === "false", "Single-select dropdown should have aria-multiselectable=false");
  - step: In my browser, I evaluate {js}
    js: |-
      let options = await toolproof.querySelectorAll(".pf-dropdown-option");
      for (let opt of options) {
        toolproof.assert(opt.getAttribute("role") === "option", "Option should have role=option");
        toolproof.assert(opt.getAttribute("aria-selected") !== null, "Option should have aria-selected");
        toolproof.assert(opt.id !== "", "Option should have an id");
      }
  - step: In my browser, I click the selector ".pf-dropdown-trigger"
  - step: In my browser, I evaluate {js}
    js: |-
      let trigger = await toolproof.querySelector(".pf-dropdown-trigger");
      await toolproof.waitFor(() => trigger.getAttribute("aria-expanded") === "true");
      toolproof.assert(trigger.getAttribute("aria-expanded") === "true", "Trigger should have aria-expanded=true after click");
      let menu = await toolproof.querySelector(".pf-dropdown-menu");
      toolproof.assert(!menu.hidden, "Menu should be visible after click");
  - step: In my browser, I evaluate {js}
    js: |-
      let dropdowns = await toolproof.querySelectorAll("pagefind-filter-dropdown");
      let firstDropdown = dropdowns[0];
      let options = firstDropdown.querySelectorAll(".pf-dropdown-option");
      toolproof.assert(options.length === 3, `Expected 3 type filter options, got ${options.length}`);
  - step: In my browser, I evaluate {js}
    js: |-
      let dropdowns = await toolproof.querySelectorAll("pagefind-filter-dropdown");
      let firstDropdown = dropdowns[0];
      let guideOption = Array.from(firstDropdown.querySelectorAll(".pf-dropdown-option")).find(el => el.textContent.includes("Guide"));
      toolproof.assert(guideOption !== undefined, "Guide option should exist");
      toolproof.assert(guideOption.getAttribute("aria-selected") === "false", "Guide should not be selected initially");
      guideOption.click();
      await toolproof.waitFor(() => guideOption.getAttribute("aria-selected") === "true");
      toolproof.assert(guideOption.getAttribute("aria-selected") === "true", "Guide should be selected after click");
  - step: In my browser, I evaluate {js}
    js: |-
      let dropdowns = await toolproof.querySelectorAll("pagefind-filter-dropdown");
      let badge = dropdowns[0].querySelector(".pf-dropdown-selected-badge");
      toolproof.assert(!badge.hasAttribute("data-pf-hidden"), "Badge should be visible when selection exists");
      toolproof.assert(badge.textContent === "1", "Badge should show 1");
  - step: In my browser, I evaluate {js}
    js: |-
      await toolproof.waitFor(() => {
        let results = document.querySelector("pagefind-results ul");
        return results && results.querySelectorAll("li").length === 2;
      });
  - step: In my browser, I press the "Escape" key
  - step: In my browser, I evaluate {js}
    js: |-
      let dropdowns = await toolproof.querySelectorAll("pagefind-filter-dropdown");
      let firstDropdown = dropdowns[0];
      let menu = firstDropdown.querySelector(".pf-dropdown-menu");
      let trigger = firstDropdown.querySelector(".pf-dropdown-trigger");
      await toolproof.waitFor(() => trigger.getAttribute("aria-expanded") === "false");
      toolproof.assert(trigger.getAttribute("aria-expanded") === "false", "Dropdown should be closed after Escape");
      toolproof.assert(menu.hidden, "Menu should be hidden after Escape");
  - step: In my browser, I click the selector "pagefind-filter-dropdown .pf-dropdown-trigger"
  - step: In my browser, I evaluate {js}
    js: |-
      let dropdowns = await toolproof.querySelectorAll("pagefind-filter-dropdown");
      let firstDropdown = dropdowns[0];
      let trigger = firstDropdown.querySelector(".pf-dropdown-trigger");
      await toolproof.waitFor(() => trigger.getAttribute("aria-expanded") === "true");
  - step: In my browser, I press the "ArrowDown" key
  - step: In my browser, I evaluate {js}
    js: |-
      let dropdowns = await toolproof.querySelectorAll("pagefind-filter-dropdown");
      let firstDropdown = dropdowns[0];
      let trigger = firstDropdown.querySelector(".pf-dropdown-trigger");
      await toolproof.waitFor(() => trigger.getAttribute("aria-activedescendant"));
      let activeId = trigger.getAttribute("aria-activedescendant");
      toolproof.assert(activeId !== null && activeId !== "", "aria-activedescendant should be set after ArrowDown");
      let focusedOption = firstDropdown.querySelector(".pf-dropdown-option-focused");
      toolproof.assert(focusedOption !== null, "An option should have the focused class");
  - step: In my browser, I evaluate {js}
    js: |-
      let dropdowns = await toolproof.querySelectorAll("pagefind-filter-dropdown");
      let firstDropdown = dropdowns[0];
      let focusedOption = firstDropdown.querySelector(".pf-dropdown-option-focused");
      window.__wasSelected = focusedOption.getAttribute("aria-selected") === "true";
  - step: In my browser, I press the " " key
  - step: In my browser, I evaluate {js}
    js: |-
      let dropdowns = await toolproof.querySelectorAll("pagefind-filter-dropdown");
      let firstDropdown = dropdowns[0];
      let focusedOption = firstDropdown.querySelector(".pf-dropdown-option-focused");
      await toolproof.waitFor(() => (focusedOption.getAttribute("aria-selected") === "true") !== window.__wasSelected);
      let isNowSelected = focusedOption.getAttribute("aria-selected") === "true";
      toolproof.assert(isNowSelected !== window.__wasSelected, "Selection should toggle after Space key");
  - step: In my browser, I press the "Escape" key
  - step: In my browser, I evaluate {js}
    js: |-
      let dropdowns = await toolproof.querySelectorAll("pagefind-filter-dropdown");
      let trigger = dropdowns[0].querySelector(".pf-dropdown-trigger");
      await toolproof.waitFor(() => trigger.getAttribute("aria-expanded") === "false");
  - step: In my browser, I evaluate {js}
    js: |-
      let dropdowns = await toolproof.querySelectorAll("pagefind-filter-dropdown");
      let singleSelectDropdown = dropdowns[1];
      let trigger = singleSelectDropdown.querySelector(".pf-dropdown-trigger");
      trigger.click();
      await toolproof.waitFor(() => trigger.getAttribute("aria-expanded") === "true");
      let menu = singleSelectDropdown.querySelector(".pf-dropdown-menu");
      toolproof.assert(!menu.hidden, "Menu should be open");
      let firstOption = menu.querySelector(".pf-dropdown-option");
      firstOption.click();
      await toolproof.waitFor(() => menu.hidden);
      toolproof.assert(menu.hidden, "Single-select dropdown should close after selection");
      toolproof.assert(trigger.getAttribute("aria-expanded") === "false", "aria-expanded should be false after single-select selection");
