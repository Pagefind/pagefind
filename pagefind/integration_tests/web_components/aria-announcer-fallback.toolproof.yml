name: Web Components Tests > ARIA announcer fallback when no component claims announcements
steps:
  - step: I have the environment variable "PAGEFIND_SITE" set to "public"
  - step: I have a "public/index.html" file with the content {html}
    html: |-
      <!DOCTYPE html><html lang="en"><head>
      <link href="/pagefind/pagefind-component-ui.css" rel="stylesheet">
      </head><body>
      <pagefind-config preload></pagefind-config>
      <pagefind-input></pagefind-input>
      <pagefind-summary></pagefind-summary>
      <!-- Note: No pagefind-results or pagefind-searchbox, so no component claims announcements -->
      <script src="/pagefind/pagefind-component-ui.js" type="module"></script>
      </body></html>
  - step: I have a "public/hello/index.html" file with the content {html}
    html: >-
      <!DOCTYPE html><html lang="en"><head></head><body><h1>Hello World</h1><p>This is content about the world.</p></body></html>
  - step: I have a "public/goodbye/index.html" file with the content {html}
    html: >-
      <!DOCTYPE html><html lang="en"><head></head><body><h1>Goodbye World</h1><p>Farewell to all.</p></body></html>
  - macro: I run Pagefind
  - step: stdout should contain "Running Pagefind"
  - step: The file "public/pagefind/pagefind.js" should not be empty
  - step: I serve the directory "public"
  - step: In my browser, I load "/"
  - step: In my browser, I evaluate {js}
    js: |-
      let announcer = document.querySelector("[data-pagefind-announcer]");
      toolproof.assert(announcer !== null, "Global announcer should exist");
  - step: In my browser, I click the selector "pagefind-input input"
  - step: In my browser, I type "world"
  - step: In my browser, the console should be empty
  - step: In my browser, I evaluate {js}
    js: |-
      let summary = await toolproof.querySelector("pagefind-summary .pf-summary");
      await toolproof.waitFor(() => summary.textContent.includes("2"), "Summary should show 2 results");
  - step: In my browser, I evaluate {js}
    js: |-
      let announcer = document.querySelector("[data-pagefind-announcer]");
      let politeRegions = announcer.querySelectorAll("[aria-live='polite']");

      await toolproof.waitFor(() => {
        return Array.from(politeRegions).some(r =>
          r.textContent.includes("2") && r.textContent.toLowerCase().includes("world")
        );
      }, "Instance should announce results as fallback when no component claims announcements");
  - step: In my browser, I click the selector ".pf-input-clear"
  - step: In my browser, I click the selector "pagefind-input input"
  - step: In my browser, I type "xyznonexistent123"
  - step: In my browser, I evaluate {js}
    js: |-
      let summary = await toolproof.querySelector("pagefind-summary .pf-summary");
      await toolproof.waitFor(() =>
        summary.textContent.toLowerCase().includes("no") || summary.textContent.includes("0"),
        "Summary should show no results"
      );
  - step: In my browser, I evaluate {js}
    js: |-
      let announcer = document.querySelector("[data-pagefind-announcer]");
      let assertiveRegions = announcer.querySelectorAll("[aria-live='assertive']");

      await toolproof.waitFor(() => {
        return Array.from(assertiveRegions).some(r =>
          r.textContent.toLowerCase().includes("no") || r.textContent.includes("0")
        );
      }, "Instance should announce no results with assertive priority as fallback");
