name: Web Components Tests > ARIA announcer for screen readers
steps:
  - step: I have the environment variable "PAGEFIND_SITE" set to "public"
  - step: I have a "public/index.html" file with the content {html}
    html: |-
      <!DOCTYPE html><html lang="en"><head>
      <link href="/pagefind/pagefind-component-ui.css" rel="stylesheet">
      </head><body>
      <pagefind-config preload></pagefind-config>
      <pagefind-input></pagefind-input>
      <pagefind-results></pagefind-results>
      <script src="/pagefind/pagefind-component-ui.js" type="module"></script>
      </body></html>
  - step: I have a "public/hello/index.html" file with the content {html}
    html: >-
      <!DOCTYPE html><html lang="en"><head></head><body><h1>Hello World</h1><p>This is content about the world.</p></body></html>
  - step: I have a "public/goodbye/index.html" file with the content {html}
    html: >-
      <!DOCTYPE html><html lang="en"><head></head><body><h1>Goodbye World</h1><p>Farewell to all.</p></body></html>
  - macro: I run Pagefind
  - step: stdout should contain "Running Pagefind"
  - step: The file "public/pagefind/pagefind.js" should not be empty
  - step: I serve the directory "public"
  - step: In my browser, I load "/"
  - step: In my browser, I evaluate {js}
    js: |-
      let announcer = document.querySelector("[data-pagefind-announcer]");
      toolproof.assert(announcer !== null, "Global announcer should exist in document");

      // 4 live regions: double-buffered (2 polite + 2 assertive)
      let allRegions = announcer.querySelectorAll("[aria-live]");
      toolproof.assert(allRegions.length === 4, `Expected 4 live regions, got ${allRegions.length}`);

      let politeRegions = announcer.querySelectorAll("[aria-live='polite']");
      let assertiveRegions = announcer.querySelectorAll("[aria-live='assertive']");
      toolproof.assert(politeRegions.length === 2, `Expected 2 polite regions, got ${politeRegions.length}`);
      toolproof.assert(assertiveRegions.length === 2, `Expected 2 assertive regions, got ${assertiveRegions.length}`);
  - step: In my browser, I evaluate {js}
    js: |-
      let announcer = document.querySelector("[data-pagefind-announcer]");
      let regions = announcer.querySelectorAll("[aria-live]");

      for (const region of regions) {
        toolproof.assert(region.getAttribute("role") === "status", "Region should have role=status");
        toolproof.assert(region.getAttribute("aria-atomic") === "true", "Region should have aria-atomic=true");
        toolproof.assert(region.hasAttribute("data-pf-sr-hidden"), "Region should be visually hidden");
      }
  - step: In my browser, I evaluate {js}
    js: |-
      // Visually hidden via clip/position (not display:none which removes from a11y tree)
      let announcer = document.querySelector("[data-pagefind-announcer]");
      let region = announcer.querySelector("[aria-live]");
      let style = window.getComputedStyle(region);

      toolproof.assert(style.position === "absolute", "Region should be absolutely positioned");
      toolproof.assert(style.display !== "none", "Region should NOT use display:none");
      toolproof.assert(style.visibility !== "hidden", "Region should NOT use visibility:hidden");
  - step: In my browser, I click the selector "pagefind-input input"
  - step: In my browser, I type "world"
  - step: In my browser, the console should be empty
  - step: In my browser, I evaluate {js}
    js: |-
      let results = await toolproof.querySelector("pagefind-results ul");
      await toolproof.waitFor(() => results.querySelectorAll("li").length === 2, "Should have 2 results");

      let announcer = document.querySelector("[data-pagefind-announcer]");
      let politeRegions = announcer.querySelectorAll("[aria-live='polite']");

      await toolproof.waitFor(() => {
        return Array.from(politeRegions).some(r =>
          r.textContent.includes("2") && r.textContent.toLowerCase().includes("world")
        );
      }, "Polite region should announce '2 results for world'");
  - step: In my browser, I click the selector ".pf-input-clear"
  - step: In my browser, I click the selector "pagefind-input input"
  - step: In my browser, I type "xyznonexistent123"
  - step: In my browser, I evaluate {js}
    js: |-
      let announcer = document.querySelector("[data-pagefind-announcer]");
      let assertiveRegions = announcer.querySelectorAll("[aria-live='assertive']");

      await toolproof.waitFor(() => {
        return Array.from(assertiveRegions).some(r =>
          r.textContent.toLowerCase().includes("no") || r.textContent.includes("0")
        );
      }, "Assertive region should announce no results");
