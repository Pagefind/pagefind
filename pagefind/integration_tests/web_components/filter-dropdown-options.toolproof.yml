name: Web Components Tests > Filter dropdown options and keyboard navigation
steps:
  - step: I have the environment variable "PAGEFIND_SITE" set to "public"
  - step: I have a "public/index.html" file with the content {html}
    html: |-
      <!DOCTYPE html><html lang="en"><head>
      <link href="/pagefind/pagefind-component-ui.css" rel="stylesheet">
      </head><body>
      <pagefind-config preload></pagefind-config>
      <pagefind-filter-dropdown id="default" filter="type" label="Type"></pagefind-filter-dropdown>
      <pagefind-filter-dropdown id="show-empty" filter="type" label="Type" show-empty></pagefind-filter-dropdown>
      <pagefind-filter-dropdown id="sorted-alpha" filter="type" label="Type" sort="alphabetical"></pagefind-filter-dropdown>
      <pagefind-filter-dropdown id="sorted-count" filter="type" label="Type" sort="count-desc"></pagefind-filter-dropdown>
      <pagefind-filter-dropdown id="wrapped" filter="type" label="Type" wrap></pagefind-filter-dropdown>
      <pagefind-input></pagefind-input>
      <pagefind-summary></pagefind-summary>
      <pagefind-results></pagefind-results>
      <script src="/pagefind/pagefind-component-ui.js" type="module"></script>
      </body></html>
  - step: I have a "public/apple/index.html" file with the content {html}
    html: |-
      <!DOCTYPE html><html lang="en"><head></head><body>
      <h1 data-pagefind-filter="type:Apple">Apple Page</h1>
      <p>Content about apples.</p>
      </body></html>
  - step: I have a "public/banana/index.html" file with the content {html}
    html: |-
      <!DOCTYPE html><html lang="en"><head></head><body>
      <h1 data-pagefind-filter="type:Banana">Banana Page</h1>
      <p>Content about bananas.</p>
      </body></html>
  - step: I have a "public/cherry-one/index.html" file with the content {html}
    html: |-
      <!DOCTYPE html><html lang="en"><head></head><body>
      <h1 data-pagefind-filter="type:Cherry">Cherry One</h1>
      <p>Content about cherries.</p>
      </body></html>
  - step: I have a "public/cherry-two/index.html" file with the content {html}
    html: |-
      <!DOCTYPE html><html lang="en"><head></head><body>
      <h1 data-pagefind-filter="type:Cherry">Cherry Two</h1>
      <p>Content about cherries.</p>
      </body></html>
  - macro: I run Pagefind
  - step: stdout should contain "Running Pagefind"
  - step: The file "public/pagefind/pagefind.js" should not be empty
  - step: I serve the directory "public"
  - step: In my browser, I load "/"
  - step: In my browser, I click the selector "pagefind-input input"
  - step: In my browser, I type "content"
  - step: In my browser, the console should be empty
  - step: In my browser, I evaluate {js}
    js: |-
      let dropdown = await toolproof.querySelector("#default");
      await toolproof.waitFor(() => {
        let menu = dropdown.querySelector(".pf-dropdown-menu");
        return menu && menu.querySelectorAll('[role="option"]').length > 0;
      });
  # Test alphabetical sorting
  - step: In my browser, I click the selector "#sorted-alpha .pf-dropdown-trigger"
  - step: In my browser, I evaluate {js}
    js: |-
      let sortedAlpha = await toolproof.querySelector("#sorted-alpha");
      let trigger = sortedAlpha.querySelector(".pf-dropdown-trigger");
      await toolproof.waitFor(() => trigger.getAttribute("aria-expanded") === "true");
  - snapshot: In my browser, the result of {js}
    js: |-
      let dropdown = await toolproof.querySelector("#sorted-alpha");
      let options = Array.from(dropdown.querySelectorAll(".pf-dropdown-option"));
      return options.map(o => {
        let label = o.querySelector(".pf-dropdown-option-label").textContent;
        let count = o.querySelector(".pf-dropdown-option-count").textContent;
        return `${label} (${count})`;
      }).join("\n");
    snapshot_content: |-
      ╎Apple (1)
      ╎Banana (1)
      ╎Cherry (2)
  - step: In my browser, I press the "Escape" key
  - step: In my browser, I click the selector "#sorted-count .pf-dropdown-trigger"
  - step: In my browser, I evaluate {js}
    js: |-
      let sortedCount = await toolproof.querySelector("#sorted-count");
      let trigger = sortedCount.querySelector(".pf-dropdown-trigger");
      await toolproof.waitFor(() => trigger.getAttribute("aria-expanded") === "true");
  - snapshot: In my browser, the result of {js}
    js: |-
      let dropdown = await toolproof.querySelector("#sorted-count");
      let options = Array.from(dropdown.querySelectorAll(".pf-dropdown-option"));
      return options.map(o => {
        let label = o.querySelector(".pf-dropdown-option-label").textContent;
        let count = o.querySelector(".pf-dropdown-option-count").textContent;
        return `${label} (${count})`;
      }).join("\n");
    snapshot_content: |-
      ╎Cherry (2)
      ╎Apple (1)
      ╎Banana (1)
  - step: In my browser, I press the "Escape" key
  - step: In my browser, I click the selector "#default .pf-dropdown-trigger"
  - step: In my browser, I evaluate {js}
    js: |-
      let dropdown = await toolproof.querySelector("#default");
      let trigger = dropdown.querySelector(".pf-dropdown-trigger");
      await toolproof.waitFor(() => trigger.getAttribute("aria-expanded") === "true");
  - step: In my browser, I press the "End" key
  - step: In my browser, I evaluate {js}
    js: |-
      let dropdown = await toolproof.querySelector("#default");
      let optionsContainer = dropdown.querySelector(".pf-dropdown-options");
      let options = dropdown.querySelectorAll(".pf-dropdown-option");
      toolproof.assert(optionsContainer.getAttribute("aria-activedescendant") === options[options.length - 1].id, "End should focus last option");
  - step: In my browser, I press the "Home" key
  - step: In my browser, I evaluate {js}
    js: |-
      let dropdown = await toolproof.querySelector("#default");
      let optionsContainer = dropdown.querySelector(".pf-dropdown-options");
      let options = dropdown.querySelectorAll(".pf-dropdown-option");
      toolproof.assert(optionsContainer.getAttribute("aria-activedescendant") === options[0].id, "Home should focus first option");
  - step: In my browser, I press the "b" key
  - step: In my browser, I evaluate {js}
    js: |-
      let dropdown = await toolproof.querySelector("#default");
      let optionsContainer = dropdown.querySelector(".pf-dropdown-options");
      await toolproof.waitFor(() => {
        let activeId = optionsContainer.getAttribute("aria-activedescendant");
        let activeOption = document.getElementById(activeId);
        return activeOption && activeOption.textContent.includes("Banana");
      });
